---
title: '阿里云 K8S 的角色权限问题'
date: 2019-10-28T17:48:09+08:00
categories:
  - K8S
tags:
  - K8S
draft: true
---

随着 k8s 的成熟, 越来越多的云平台都集成了 k8s, 基本都成了半傻瓜式操作. 我们公司用的是阿里云平台, 但是在进行授权管理时遇到了一些与预想不一致的情况.

<!--more-->

### 背景

由于我们公司没有专职运维人员, 赋予了一些开发者发布权限, 所以我们需要按照需要给不同的开发者不同的权限, 而且为了透明, 新同事也会拥有只读权限.

### 问题

遇到的问题是, 阿里云的访问权限控制粒度太粗, 赋予的权限比预期大.

### 深入了解

首先来看看阿里云 k8s 用户授权说明:

![role](/ali-k8s/role.png)

根据最后一条可以看出, 阿里云其实是通过绑定不同的 `ClusterRole` 给不同的阿里云不同 RAM 账号来实现权限管理的.

k8s 权限管理基本都是基于 `RBAC` 策略为不同角色定义不同的资源和操作来做到权限管理的, 所以 `ClusterRole` 也是通过 RBAC 做权限控制的.

我们看一个定义文件:

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: test
rules:
  - apiGroups:
      - ''
    resources:
      - pods
    verbs:
      - create
      - delete
      - deletecollection
      - get
      - list
      - patch
      - update
      - watch
```

其实控制的是不同 api 资源的访问, 比如上图, test 角色就被赋予了 pods 相关 API 的读写权限, 可以看出读操作为 get, list, watch 而剩下来的都算作写权限.

再回头看看阿里云权限说明那张图片, 咋看一下没什么问题, "开发人员, 对所有命名空间或所选命名空间下控制台可见资源的`读写`权限", "受限用户, 对所有命名空间或所选命名空间下控制台可见资源的`只读`权限", 总结一下就是受限用户给只读, 开发人员给读写可以更改.

仔细想想, k8s 的不同资源敏感度是不同的, 比如说 `secret(保密字典)` 服务, 他的安全级别非常高, 里面基本都是敏感信息, 受限用户甚至开发人员都不应该对它有权限, 但是你会发现阿里云的受限用户都可以在管理控制台相应的菜单里面看到保密字典中的数据, 还是明文的(因为就算在 k8s 中 secret 值也只是简单的 base64). 同理进入容器的操作也是的.
